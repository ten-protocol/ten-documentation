"use strict";(self.webpackChunkten_docs=self.webpackChunkten_docs||[]).push([[2664],{4159:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>d,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"write-ten-dapp/session-keys","title":"Account Abstraction & Session Keys in TEN","description":"In the classic Account Abstraction model (EIP\u20114337) described on ethereum.org, \u201csession keys\u201d (SKs) are typically implemented using proxy smart contracts and a bundler.","source":"@site/docs/4-write-ten-dapp/4-session-keys.md","sourceDirName":"4-write-ten-dapp","slug":"/write-ten-dapp/session-keys","permalink":"/docs/write-ten-dapp/session-keys","draft":false,"unlisted":false,"editUrl":"https://github.com/ten-protocol/ten-documentation/blob/main/docs/4-write-ten-dapp/4-session-keys.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4},"sidebar":"tutorialSidebar","previous":{"title":"Network Configuration","permalink":"/docs/write-ten-dapp/network-setup"},"next":{"title":"Cross-Chain Bridging","permalink":"/docs/write-ten-dapp/bridging"}}');var t=n(4848),r=n(8453);const a={sidebar_position:4},o="Account Abstraction & Session Keys in TEN",d={},c=[{value:"High\u2011level flow for dApps",id:"highlevel-flow-for-dapps",level:2},{value:"Using session keys via custom queries",id:"using-session-keys-via-custom-queries",level:2},{value:"1. Create a session key",id:"1-create-a-session-key",level:3},{value:"2. Fund the session key",id:"2-fund-the-session-key",level:3},{value:"Sending transactions with a session key",id:"sending-transactions-with-a-session-key",level:2},{value:"1) Custom\u2011query signing (low\u2011level)",id:"1-customquery-signing-lowlevel",level:3},{value:"2) Direct <code>eth_sendTransaction</code> with a session key",id:"2-direct-eth_sendtransaction-with-a-session-key",level:3},{value:"Deleting and expiring session keys",id:"deleting-and-expiring-session-keys",level:2},{value:"Manual deletion via custom query",id:"manual-deletion-via-custom-query",level:3},{value:"Automatic expiration &amp; fund recovery",id:"automatic-expiration--fund-recovery",level:3},{value:"UX &amp; safety considerations for dApp developers",id:"ux--safety-considerations-for-dapp-developers",level:2}];function l(e){const s={a:"a",br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.header,{children:(0,t.jsx)(s.h1,{id:"account-abstraction--session-keys-in-ten",children:"Account Abstraction & Session Keys in TEN"})}),"\n",(0,t.jsxs)(s.p,{children:["In the classic Account Abstraction model (EIP\u20114337) described on ",(0,t.jsx)(s.a,{href:"https://ethereum.org/roadmap/account-abstraction/",children:"ethereum.org"}),", \u201csession keys\u201d (SKs) are typically implemented using proxy smart contracts and a bundler.",(0,t.jsx)(s.br,{}),"\n","TEN\u2019s Account Abstraction design, outlined in ",(0,t.jsx)(s.a,{href:"https://medium.com/p/2e85bde4c54d",children:"this post"}),", instead provides ",(0,t.jsx)(s.strong,{children:"native session keys managed by the gateway and TEEs"}),", eliminating the need for proxy contracts or a bundler."]}),"\n",(0,t.jsx)(s.p,{children:"Session keys in TEN are:"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"Ephemeral Ethereum accounts"})," managed by the gateway on behalf of a user."]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"Linked to the user\u2019s viewing key / encryption token"})," (",(0,t.jsx)(s.a,{href:"https://docs.ten.xyz/docs/write-ten-dapp/programmable-gateway-access",children:"details"}),")."]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"Used to sign and submit transactions"})," via the gateway, enabling \u201cno\u2011click\u201d UX for dApps."]}),"\n"]}),"\n",(0,t.jsxs)(s.p,{children:["Each user can have ",(0,t.jsx)(s.strong,{children:"multiple session keys"})," (up to 100), and the gateway can automatically expire idle keys and recover funds back to the user\u2019s primary account."]}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h2,{id:"highlevel-flow-for-dapps",children:"High\u2011level flow for dApps"}),"\n",(0,t.jsx)(s.p,{children:"Imagine an on\u2011chain game that wants a smooth UX without prompting the user to sign every move:"}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"User authenticates to the gateway"})," and gets an ",(0,t.jsx)(s.code,{children:"encryptionToken"}),"."]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"Gateway creates a session key"})," for this user and exposes its address."]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"User funds the session key"})," with a normal, user\u2011signed transfer."]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"Game sends transactions using the session key"})," (no additional wallet popups)."]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"Gateway tracks activity and can expire/clean up idle session keys"}),", sweeping funds back to the account which was first authenticated with the gateway."]}),"\n"]}),"\n",(0,t.jsx)(s.p,{children:"From the dApp\u2019s point of view, a session key behaves like a normal Ethereum account whose private key is held inside the TEE\u2011backed gateway."}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h2,{id:"using-session-keys-via-custom-queries",children:"Using session keys via custom queries"}),"\n",(0,t.jsxs)(s.p,{children:["On TEN, session key management is exposed as ",(0,t.jsx)(s.strong,{children:"custom queries"})," behind standard JSON\u2011RPC, primarily via ",(0,t.jsx)(s.code,{children:"eth_getStorageAt"})," with special \u201cmethod addresses\u201d."]}),"\n",(0,t.jsx)(s.p,{children:"All examples below assume you are calling through the gateway:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-text",children:"https://testnet-rpc.ten.xyz/v1/?token=<EncryptionToken>\n"})}),"\n",(0,t.jsx)(s.h3,{id:"1-create-a-session-key",children:"1. Create a session key"}),"\n",(0,t.jsx)(s.p,{children:"To create a new session key for the authenticated user:"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["Call ",(0,t.jsx)(s.code,{children:"eth_getStorageAt"})," with:","\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"address"}),": ",(0,t.jsx)(s.code,{children:"0x0000000000000000000000000000000000000003"})]}),"\n",(0,t.jsx)(s.li,{children:"other parameters can be left as in the example below."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(s.p,{children:["The response returns the ",(0,t.jsx)(s.strong,{children:"hex\u2011encoded address"})," of the new session key."]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-javascript",children:'async function createSessionKey(encryptionToken) {\n  const response = await fetch(\n    `https://testnet-rpc.ten.xyz/v1/?token=${encryptionToken}`,\n    {\n      method: "POST",\n      headers: { "Content-Type": "application/json" },\n      body: JSON.stringify({\n        jsonrpc: "2.0",\n        method: "eth_getStorageAt",\n        params: [\n          "0x0000000000000000000000000000000000000003", // create SK\n          "0x0",\n          "latest",\n        ],\n        id: 1,\n      }),\n    },\n  );\n\n  const data = await response.json();\n  return data.result; // Session key address (0x...)\n}\n'})}),"\n",(0,t.jsx)(s.h3,{id:"2-fund-the-session-key",children:"2. Fund the session key"}),"\n",(0,t.jsxs)(s.p,{children:["Once you have the session key address, fund it with a ",(0,t.jsx)(s.strong,{children:"normal user\u2011signed transaction"})," from the user\u2019s main wallet:"]}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["Build a standard ",(0,t.jsx)(s.code,{children:"eth_sendTransaction"})," / wallet transaction from the user\u2019s account to the session key address."]}),"\n",(0,t.jsx)(s.li,{children:"Let the wallet sign and submit it."}),"\n"]}),"\n",(0,t.jsx)(s.p,{children:"The gateway observes this and considers the session key funded and ready to use."}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h2,{id:"sending-transactions-with-a-session-key",children:"Sending transactions with a session key"}),"\n",(0,t.jsx)(s.p,{children:"There are two main integration patterns:"}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"Custom\u2011query based signing"})," (low\u2011level; uses ",(0,t.jsx)(s.code,{children:"eth_getStorageAt"}),")."]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsxs)(s.strong,{children:["Direct ",(0,t.jsx)(s.code,{children:"eth_sendTransaction"})," from the session key"]})," (simpler, when your client library supports it)."]}),"\n"]}),"\n",(0,t.jsx)(s.h3,{id:"1-customquery-signing-lowlevel",children:"1) Custom\u2011query signing (low\u2011level)"}),"\n",(0,t.jsx)(s.p,{children:"You can ask the gateway to sign and submit an unsigned transaction using the session key by calling:"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"eth_getStorageAt"})," with ",(0,t.jsx)(s.strong,{children:"address"})," ",(0,t.jsx)(s.code,{children:"0x0000000000000000000000000000000000000005"})]}),"\n",(0,t.jsx)(s.li,{children:"The second parameter encodes:"}),"\n"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-json",children:'{\n  "sessionKeyAddress": "0x...", // Session key address\n  "tx": "base64_encoded_transaction" // Unsigned transaction, base64\u2011encoded\n}\n'})}),"\n",(0,t.jsx)(s.p,{children:"Example:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-javascript",children:'async function sendWithSessionKey(\n  encryptionToken,\n  sessionKeyAddress,\n  unsignedTx,\n) {\n  const txBase64 = btoa(JSON.stringify(unsignedTx)); // client\u2011side encoding\n\n  const response = await fetch(\n    `https://testnet-rpc.ten.xyz/v1/?token=${encryptionToken}`,\n    {\n      method: "POST",\n      headers: { "Content-Type": "application/json" },\n      body: JSON.stringify({\n        jsonrpc: "2.0",\n        method: "eth_getStorageAt",\n        params: [\n          "0x0000000000000000000000000000000000000005", // sign+send with SK\n          JSON.stringify({\n            sessionKeyAddress,\n            tx: txBase64,\n          }),\n          "latest",\n        ],\n        id: 1,\n      }),\n    },\n  );\n\n  const data = await response.json();\n  return data.result; // tx hash\n}\n'})}),"\n",(0,t.jsxs)(s.p,{children:["The gateway first confirms that the session key belongs to the user identified by ",(0,t.jsx)(s.code,{children:"encryptionToken"}),". It then signs the transaction with the session key\u2019s private key and sends it to the TEN node."]}),"\n",(0,t.jsxs)(s.h3,{id:"2-direct-eth_sendtransaction-with-a-session-key",children:["2) Direct ",(0,t.jsx)(s.code,{children:"eth_sendTransaction"})," with a session key"]}),"\n",(0,t.jsxs)(s.p,{children:["You can send transactions directly using ",(0,t.jsx)(s.code,{children:"eth_sendTransaction"})," by setting the ",(0,t.jsx)(s.code,{children:"from"})," field to a session key address that belongs to the authenticated user. The gateway signs the transaction with the session key's private key and broadcasts it."]}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.strong,{children:"Requirements:"})}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["The request must include the user's ",(0,t.jsx)(s.code,{children:"encryptionToken"})," (same authentication as other gateway calls)."]}),"\n",(0,t.jsxs)(s.li,{children:["The ",(0,t.jsx)(s.code,{children:"from"})," address must be a session key owned by that user."]}),"\n",(0,t.jsxs)(s.li,{children:["The transaction must include all required fields (",(0,t.jsx)(s.code,{children:"gas"}),", ",(0,t.jsx)(s.code,{children:"gasPrice"})," or ",(0,t.jsx)(s.code,{children:"maxFeePerGas"}),"/",(0,t.jsx)(s.code,{children:"maxPriorityFeePerGas"}),", ",(0,t.jsx)(s.code,{children:"nonce"}),", etc.). The gateway does not auto-fill missing fields."]}),"\n"]}),"\n",(0,t.jsxs)(s.p,{children:["The gateway verifies that the session key belongs to the user identified by ",(0,t.jsx)(s.code,{children:"encryptionToken"}),", signs the transaction with the session key's private key, and sends it to the TEN node."]}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.strong,{children:"Error handling:"})}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["If ",(0,t.jsx)(s.code,{children:"from"})," is not a session key for the authenticated user, the call fails with an error indicating the session key address was not found."]}),"\n",(0,t.jsx)(s.li,{children:"If the session key lacks sufficient balance, the transaction is rejected by the network (not by the gateway)."}),"\n",(0,t.jsxs)(s.li,{children:["Standard authentication errors apply if the ",(0,t.jsx)(s.code,{children:"encryptionToken"})," is missing or invalid."]}),"\n"]}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h2,{id:"deleting-and-expiring-session-keys",children:"Deleting and expiring session keys"}),"\n",(0,t.jsx)(s.h3,{id:"manual-deletion-via-custom-query",children:"Manual deletion via custom query"}),"\n",(0,t.jsx)(s.p,{children:"To explicitly delete a session key:"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["Call ",(0,t.jsx)(s.code,{children:"eth_getStorageAt"})," with ",(0,t.jsx)(s.strong,{children:"address"})," ",(0,t.jsx)(s.code,{children:"0x0000000000000000000000000000000000000004"})," and a JSON payload:"]}),"\n"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-json",children:'{\n  "sessionKeyAddress": "0x..." // Session key address to delete\n}\n'})}),"\n",(0,t.jsx)(s.p,{children:"The gateway:"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:"Removes the session key from storage (access to the private key is lost forever)."}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"Sweeps remaining funds"})," back to the user\u2019s primary account, using its internal ",(0,t.jsx)(s.code,{children:"TxSender"}),"."]}),"\n"]}),"\n",(0,t.jsx)(s.h3,{id:"automatic-expiration--fund-recovery",children:"Automatic expiration & fund recovery"}),"\n",(0,t.jsxs)(s.p,{children:["In addition, the gateway runs a background ",(0,t.jsx)(s.strong,{children:"SessionKeyExpirationService"}),":"]}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:"Tracks last activity for each session key."}),"\n",(0,t.jsxs)(s.li,{children:["Periodically scans for keys older than ",(0,t.jsx)(s.code,{children:"--sessionKeyExpirationThreshold"}),"."]}),"\n",(0,t.jsxs)(s.li,{children:["For each candidate, it:","\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:"Reloads the owning user."}),"\n",(0,t.jsx)(s.li,{children:"Attempts to move remaining funds back to the user\u2019s primary account."}),"\n",(0,t.jsx)(s.li,{children:"Removes the key from the activity tracker and persists updated state."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h2,{id:"ux--safety-considerations-for-dapp-developers",children:"UX & safety considerations for dApp developers"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"Balance management"}),": Track the session key\u2019s balance (e.g. via ",(0,t.jsx)(s.code,{children:"eth_getBalance"}),") and top it up when needed."]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"Per\u2011dApp keys"}),": Use separate session keys per dApp / game instance if you want stronger isolation."]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"Lifecycle"}),": Delete or let the gateway expire session keys when they are no longer needed to keep the system tidy."]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"Security"}),": The session key\u2019s private key never leaves the TEE\u2011backed gateway, but users should still treat them as scoped spending keys and only fund them with limited amounts."]}),"\n"]}),"\n",(0,t.jsxs)(s.p,{children:["Combined with ",(0,t.jsx)(s.strong,{children:"programmable access tokens"})," (",(0,t.jsx)(s.code,{children:"encryptionToken"}),") and the TEN gateway, session keys give you EIP\u20114337\u2011style UX without additional contracts or bundler infrastructure."]})]})}function h(e={}){const{wrapper:s}={...(0,r.R)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}},8453:(e,s,n)=>{n.d(s,{R:()=>a,x:()=>o});var i=n(6540);const t={},r=i.createContext(t);function a(e){const s=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function o(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:a(e.components),i.createElement(r.Provider,{value:s},e.children)}}}]);